<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="api-base" content="http://localhost:8000/api" />
    <title>Shared Resource Calendar</title>
    <link rel="stylesheet" href="static/output.css" />
    <script src="https://unpkg.com/htmx.org@1.9.10" crossorigin="anonymous"></script>
    <style>
      .native-date-input {
        color: transparent;
        caret-color: transparent;
        -webkit-text-fill-color: transparent;
      }
      .native-date-input::-webkit-datetime-edit,
      .native-date-input::-webkit-datetime-edit-fields-wrapper,
      .native-date-input::-webkit-datetime-edit-text,
      .native-date-input::-webkit-datetime-edit-month-field,
      .native-date-input::-webkit-datetime-edit-day-field,
      .native-date-input::-webkit-datetime-edit-year-field,
      .native-date-input::-webkit-clear-button,
      .native-date-input::-webkit-inner-spin-button {
        display: none;
      }
      .native-date-input:focus {
        outline: none;
      }
      .native-date-input::-ms-input-placeholder,
      .native-date-input::placeholder {
        color: transparent;
      }
    </style>
  </head>
  <body>
    <main class="mx-auto flex min-h-screen w-full max-w-6xl flex-col gap-6 px-6 py-12">
      <section class="space-y-10">
        <header class="flex flex-col gap-4 xl:flex-row xl:items-end xl:justify-between">
          <div class="space-y-2">
            <h1 id="resource-title" class="text-3xl font-semibold">Loading.</h1>
            <p class="text-sm text-slate-600">Shared calendar for the Riederalp.</p>
            <p id="calendar-updated" class="text-xs text-slate-400">Checking availability.</p>
          </div>
          <div class="flex flex-wrap items-center gap-3">
            <div class="rounded-lg border border-slate-200 bg-white px-4 py-3 shadow-sm">
              <p class="text-xs font-medium uppercase tracking-wide text-slate-500">Next open date</p>
              <p id="calendar-next-open" class="text-sm font-semibold text-slate-700">—</p>
            </div>
          </div>
        </header>

        <section class="grid gap-6 xl:grid-cols-[minmax(0,2fr)_minmax(0,1fr)]">
          <article class="space-y-6 rounded-xl border border-slate-200 bg-white p-6 shadow-sm">
            <header class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
              <div>
                <h2 class="text-xl font-semibold text-slate-900">Availability</h2>
                <p id="calendar-month-label" class="text-sm text-slate-500">—</p>
              </div>
              <div class="flex flex-wrap items-center gap-2">
                <button class="inline-flex items-center rounded-md border border-slate-200 px-3 py-1.5 text-sm font-medium text-slate-600 transition hover:border-indigo-300 hover:text-indigo-600" type="button" data-calendar-action="prev">&#8592; Prev</button>
                <button class="inline-flex items-center rounded-md border border-slate-200 px-3 py-1.5 text-sm font-medium text-slate-600 transition hover:border-indigo-300 hover:text-indigo-600" type="button" data-calendar-action="today">Today</button>
                <button class="inline-flex items-center rounded-md border border-slate-200 px-3 py-1.5 text-sm font-medium text-slate-600 transition hover:border-indigo-300 hover:text-indigo-600" type="button" data-calendar-action="next">Next &#8594;</button>
              </div>
            </header>

            <div class="flex flex-wrap items-center gap-4 text-xs text-slate-500">
              <span class="inline-flex items-center gap-2"><span class="h-2 w-2 rounded-full bg-emerald-500"></span>Available</span>
              <span class="inline-flex items-center gap-2"><span class="h-2 w-2 rounded-full bg-indigo-500"></span>Booked</span>
              <span class="inline-flex items-center gap-2"><span class="h-2 w-2 rounded-full bg-amber-500"></span>Awaiting approval</span>
            </div>

            <div id="calendar-grid" class="space-y-2">
              <p class="text-sm text-slate-500">Loading calendar…</p>
            </div>
          </article>

          <article class="rounded-xl border border-slate-200 bg-white p-6 shadow-sm">
            <header class="space-y-2">
              <h2 class="text-xl font-semibold text-slate-900">New request</h2>
              <p class="text-sm text-slate-500">Share details to add a booking to the calendar.</p>
            </header>
            <div id="new-request-status" class="mt-4 hidden rounded-md border px-3 py-2 text-sm"></div>
            <form id="new-request-form" class="mt-4 space-y-4">
              <div class="space-y-1">
                <label class="text-xs font-medium uppercase tracking-wide text-slate-500" for="request-full-name">Guest name</label>
                <input class="w-full rounded-md border border-slate-200 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-100" id="request-full-name" name="fullName" type="text" required maxlength="255" placeholder="MaPi" />
              </div>
              <div class="grid gap-4 sm:grid-cols-2">
                <div class="space-y-1 relative">
                  <label class="text-xs font-medium uppercase tracking-wide text-slate-500" for="request-start-date">Start date</label>
                  <!-- display input -->
                  <input class="w-full rounded-md border border-slate-200 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-100"
                         id="request-start-date" name="startDate" type="text" inputmode="numeric"
                         pattern="(?:\d{2}\.\d{2}\.\d{4}|\d{4}-\d{2}-\d{2})"
                         placeholder="01.02.2024" autocomplete="off" required />
                  <!-- native picker sits on top, invisible but clickable -->
                  <input id="request-start-date-picker" type="date" lang="de-CH"
                         class="native-date-input absolute inset-0 h-full w-full opacity-0 z-10" aria-hidden="true" />
                </div>
                <div class="space-y-1 relative">
                  <label class="text-xs font-medium uppercase tracking-wide text-slate-500" for="request-end-date">End date</label>
                  <!-- display input -->
                  <input class="w-full rounded-md border border-slate-200 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-100"
                         id="request-end-date" name="endDate" type="text" inputmode="numeric"
                         pattern="(?:\d{2}\.\d{2}\.\d{4}|\d{4}-\d{2}-\d{2})"
                         placeholder="05.02.2024" autocomplete="off" required />
                  <!-- native picker sits on top, invisible but clickable -->
                  <input id="request-end-date-picker" type="date" lang="de-CH"
                         class="native-date-input absolute inset-0 h-full w-full opacity-0 z-10" aria-hidden="true" />
                </div>
              </div>
              <div class="space-y-1">
                <label class="text-xs font-medium uppercase tracking-wide text-slate-500" for="request-notes">Notes (optional)</label>
                <textarea class="min-h-[96px] w-full rounded-md border border-slate-200 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-100" id="request-notes" name="notes" placeholder="Share arrival details or special requirements."></textarea>
              </div>
              <input id="request-resource-id" name="resourceId" type="hidden" />
              <div class="flex items-center justify-end gap-3 pt-2">
                <button class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-indigo-500" type="submit" id="new-request-submit">Submit request</button>
              </div>
            </form>
          </article>
        </section>
      </section>

      <script>
      function parseMonthSlug(monthSlug) {
        if (!monthSlug) return null;
        const parts = monthSlug.split('-');
        if (parts.length !== 2) return null;
        const year = Number(parts[0]);
        const month = Number(parts[1]);
        if (!Number.isFinite(year) || !Number.isFinite(month) || month < 1 || month > 12) {
          return null;
        }
        return new Date(Date.UTC(year, month - 1, 1));
      }

      function buildFallbackWeeks(anchor, todayIso) {
        const weeks = [];
        const month = anchor.getUTCMonth();
        const weekStart = new Date(Date.UTC(anchor.getUTCFullYear(), anchor.getUTCMonth(), 1));
        const offset = (weekStart.getUTCDay() + 6) % 7; // Monday
        weekStart.setUTCDate(weekStart.getUTCDate() - offset);
        let currentStart = weekStart;
        while (weeks.length < 6) {
          const week = [];
          for (let i = 0; i < 7; i += 1) {
            const current = new Date(currentStart);
            current.setUTCDate(currentStart.getUTCDate() + i);
            const iso = current.toISOString().split('T')[0];
            week.push({
              iso,
              dayLabel: String(current.getUTCDate()),
              isCurrentMonth: current.getUTCMonth() === month,
              isToday: iso === todayIso,
              isUnavailable: false,
              isFull: false,
              pendingCount: 0,
              remainingSlots: 0,
              bookings: [],
            });
          }
          weeks.push(week);
          const nextWeekStart = new Date(currentStart);
          nextWeekStart.setUTCDate(currentStart.getUTCDate() + 7);
          let nextWeekHasCurrentDay = false;
          for (let i = 0; i < 7; i += 1) {
            const probe = new Date(nextWeekStart);
            probe.setUTCDate(nextWeekStart.getUTCDate() + i);
            if (probe.getUTCMonth() === month) { nextWeekHasCurrentDay = true; break; }
          }
          if (!nextWeekHasCurrentDay) break;
          currentStart = nextWeekStart;
        }
        return weeks;
      }

      function buildFallbackResponse(anchorDate, todayDate, preferredIso) {
        const todayIso = todayDate.toISOString().split('T')[0];
        const calendarWeeks = buildFallbackWeeks(anchorDate, todayIso);
        const calendar = {
          weeks: calendarWeeks,
          weekdayLabels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
          monthLabel: anchorDate.toLocaleString('en-US', { month: 'long', year: 'numeric' }),
          selectedIso: preferredIso ?? todayIso,
          totalBookings: 0,
          pendingCount: 0,
          remainingSlots: 0,
          nextAvailableLabel: todayDate.toLocaleDateString('en-US', {
            weekday: 'short', day: '2-digit', month: 'short', year: 'numeric',
          }),
          updatedLabel: 'Updated just now',
        };

        const dayDetails = {};
        calendar.weeks.flat().forEach((day) => {
          const pendingCount = day.pendingCount ?? day.bookings.filter((b) => b.status === 'pending').length;
          const confirmedCount = day.bookings.filter((b) => b.status === 'confirmed' || b.status === 'approved').length;
          dayDetails[day.iso] = {
            iso: day.iso,
            date: day.iso,
            dateLabel: formatDisplayDateFromIso(day.iso),
            confirmedCount,
            pendingCount,
            remainingSlots: day.remainingSlots ?? 0,
            bookings: day.bookings,
            summary: day.bookings.length
              ? 'Review guest details, confirm approvals, or release slots as needed.'
              : day.isUnavailable
                ? 'House unavailable today for scheduled maintenance.'
                : 'Wide open day ready for a new booking.',
          };
        });

        const selectedIso = dayDetails[calendar.selectedIso] ? calendar.selectedIso : todayIso;
        calendar.selectedIso = selectedIso;

        return {
          response: {
            resource: { id: 'alder-lake-house', name: 'alder-lake-house', displayName: 'Riederalp' },
            calendar,
            selectedDay: dayDetails[selectedIso] ?? null,
            pendingRequests: [],
          },
          dayDetails,
        };
      }

      const fallbackToday = new Date();
      const fallbackAnchor = new Date(Date.UTC(fallbackToday.getUTCFullYear(), fallbackToday.getUTCMonth(), 1));
      const fallbackInit = buildFallbackResponse(fallbackAnchor, fallbackToday, null);
      const fallbackResponse = fallbackInit.response;
      const fallbackDayDetails = fallbackInit.dayDetails;

      const state = {
        response: null,
        selectedDay: null,
        dayCache: new Map(Object.entries(fallbackDayDetails).map(([date, detail]) => [date, clone(detail)])),
        currentMonth: null,
      };

      const DEFAULT_RESOURCE_ID = 'alder-lake-house';
      const newRequestForm = document.getElementById('new-request-form');
      const newRequestStatus = document.getElementById('new-request-status');
      const newRequestSubmit = document.getElementById('new-request-submit');
      const newRequestStatusBaseClass = 'mt-4 rounded-md border px-3 py-2 text-sm';
      const newRequestSubmitLabel = newRequestSubmit ? (newRequestSubmit.textContent?.trim() || 'Submit request') : 'Submit request';
      const startDateDisplay = newRequestForm?.elements.namedItem('startDate') ?? null;
      const endDateDisplay = newRequestForm?.elements.namedItem('endDate') ?? null;
      const startDatePicker = newRequestForm ? newRequestForm.querySelector('#request-start-date-picker') : null;
      const endDatePicker = newRequestForm ? newRequestForm.querySelector('#request-end-date-picker') : null;

      function clone(v) { return v == null ? v : JSON.parse(JSON.stringify(v)); }

      const apiBaseMeta = document.querySelector('meta[name="api-base"]');
      const apiBase = apiBaseMeta?.content ?? '/api';

      function pad(n) { return String(n).padStart(2, '0'); }
      function formatMonthFromDate(d) { return `${d.getUTCFullYear()}-${pad(d.getUTCMonth() + 1)}`; }
      function formatIsoDate(d) { return d.toISOString().split('T')[0]; }
      function formatDisplayDateFromIso(iso) {
        if (typeof iso !== 'string' || !iso) return '';
        const parts = iso.split('-');
        if (parts.length !== 3) return '';
        const [y, m, dd] = parts;
        if (y.length !== 4 || m.length !== 2 || dd.length !== 2) return '';
        return `${dd}.${m}.${y}`;
      }

      function parseDisplayDate(value) {
        if (typeof value !== 'string') return null;
        const trimmed = value.trim();
        const isoMatch = /^(\d{4})-(\d{2})-(\d{2})$/.exec(trimmed);
        if (isoMatch) {
          const [, y, m, d] = isoMatch;
          const Y = Number(y), M = Number(m), D = Number(d);
          const date = new Date(Date.UTC(Y, M - 1, D));
          if (Number.isNaN(date.getTime())) return null;
          if (date.getUTCFullYear() !== Y || date.getUTCMonth() + 1 !== M || date.getUTCDate() !== D) return null;
          return `${y}-${m}-${d}`;
        }
        const match = /^(\d{2})\.(\d{2})\.(\d{4})$/.exec(trimmed);
        if (!match) return null;
        const [, d, m, y] = match;
        const Y = Number(y), M = Number(m), D = Number(d);
        const date = new Date(Date.UTC(Y, M - 1, D));
        if (Number.isNaN(date.getTime())) return null;
        if (date.getUTCFullYear() !== Y || date.getUTCMonth() + 1 !== M || date.getUTCDate() !== D) return null;
        return `${date.getUTCFullYear()}-${pad(date.getUTCMonth() + 1)}-${pad(date.getUTCDate())}`;
      }

      function buildPlaceholderEmail(name) {
        const normalized = typeof name === 'string' ? name.toLowerCase() : '';
        const base = normalized.replace(/[^a-z0-9]+/g, '-').replace(/^-+/, '').replace(/-+$/, '').slice(0, 24);
        const localPart = base ? `${base}-${Date.now().toString(36)}` : `guest-${Date.now().toString(36)}`;
        return `${localPart}@example.com`;
      }

      function monthFromCalendar(calendar) {
        if (!calendar?.weeks) return null;
        const currentDay = calendar.weeks.flat().find((d) => d.isCurrentMonth && d.iso);
        return currentDay ? currentDay.iso.slice(0, 7) : null;
      }

      function resolveCurrentMonth() {
        return state.currentMonth || monthFromCalendar(state.response?.calendar) || formatMonthFromDate(new Date());
      }

      async function api(path, options) {
        if (!apiBase) throw new Error('No API base configured.');
        const response = await fetch(`${apiBase}${path}`, { headers: { 'Content-Type': 'application/json' }, ...options });
        if (!response.ok) {
          let message = `Request failed with ${response.status}`;
          try {
            const errorBody = await response.json();
            if (typeof errorBody?.detail === 'string') message = errorBody.detail;
            else if (Array.isArray(errorBody?.detail)) message = errorBody.detail.map((i) => i?.msg ?? i?.message ?? 'Validation error').join(', ');
          } catch {
            try { const txt = await response.text(); if (txt) message = txt; } catch {}
          }
          throw new Error(message);
        }
        return response.json();
      }

      function currentResourceId() { return state.response?.resource?.id ?? DEFAULT_RESOURCE_ID; }

      function hideNewRequestStatus() {
        if (!newRequestStatus) return;
        newRequestStatus.textContent = '';
        newRequestStatus.className = `hidden ${newRequestStatusBaseClass}`;
      }
      function showNewRequestStatus(message, tone = 'info') {
        if (!newRequestStatus) return;
        const toneClass = tone === 'error'
          ? 'border-rose-200 bg-rose-50 text-rose-700'
          : 'border-emerald-200 bg-emerald-50 text-emerald-700';
        newRequestStatus.textContent = message;
        newRequestStatus.className = `${newRequestStatusBaseClass} ${toneClass}`;
      }
      function setNewRequestSubmitting(isSubmitting) {
        if (!newRequestSubmit) return;
        newRequestSubmit.disabled = isSubmitting;
        if (isSubmitting) { newRequestSubmit.textContent = 'Submitting…'; newRequestSubmit.classList.add('opacity-70'); }
        else { newRequestSubmit.textContent = newRequestSubmitLabel; newRequestSubmit.classList.remove('opacity-70'); }
      }

      function prefillRequestForm(preferredDate) {
        if (!newRequestForm) return;
        const fallbackDate = preferredDate ?? state.selectedDay?.iso ?? formatIsoDate(new Date());
        if (startDateDisplay instanceof HTMLInputElement) startDateDisplay.value = formatDisplayDateFromIso(fallbackDate);
        if (startDatePicker instanceof HTMLInputElement) startDatePicker.value = fallbackDate;

        let resolvedEndIso = fallbackDate;
        if (endDateDisplay instanceof HTMLInputElement) {
          const currentEndIso = parseDisplayDate(endDateDisplay.value);
          if (currentEndIso && currentEndIso >= fallbackDate) resolvedEndIso = currentEndIso;
          endDateDisplay.value = formatDisplayDateFromIso(resolvedEndIso);
        }
        if (endDatePicker instanceof HTMLInputElement) {
          const pickerEndIso = parseDisplayDate(endDatePicker.value) ?? endDatePicker.value;
          if (pickerEndIso && pickerEndIso >= fallbackDate) resolvedEndIso = pickerEndIso;
          endDatePicker.value = resolvedEndIso;
          endDatePicker.min = fallbackDate;
        }
        const resourceInput = newRequestForm.elements.namedItem('resourceId');
        if (resourceInput instanceof HTMLInputElement) resourceInput.value = currentResourceId();
      }

      function statusClassForDay(day) {
        if (day.isUnavailable) return 'border-slate-200 bg-slate-100 text-slate-500';
        if (day.isFull) return 'border-rose-200 bg-rose-50 text-rose-700';
        if ((day.pendingCount ?? 0) > 0) return 'border-amber-200 bg-amber-50';
        if (day.bookings.length > 0) return 'border-indigo-200 bg-indigo-50';
        return 'border-slate-200 bg-white';
      }

      function renderSummary(response) {
        const titleEl = document.getElementById('resource-title');
        if (titleEl) titleEl.textContent = response.resource.displayName;
        const updatedEl = document.getElementById('calendar-updated');
        if (updatedEl) updatedEl.textContent = response.calendar.updatedLabel ?? 'Updated just now';
        const nextOpenEl = document.getElementById('calendar-next-open');
        if (nextOpenEl) nextOpenEl.textContent = response.calendar.nextAvailableLabel ?? 'Check the calendar';
        const monthLabelEl = document.getElementById('calendar-month-label');
        if (monthLabelEl) monthLabelEl.textContent = response.calendar.monthLabel;
      }

      function renderCalendarGrid(calendar) {
        const container = document.getElementById('calendar-grid');
        if (!container) return;
        const labels = calendar.weekdayLabels.length > 0 ? calendar.weekdayLabels : ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        const header = `<div class="grid grid-cols-7 gap-1 text-xs font-medium uppercase tracking-wide text-slate-500">${labels.map((l) => `<span class="px-2 py-1 text-center">${l}</span>`).join('')}</div>`;
        const weeks = calendar.weeks.map((week) => {
          const days = week.map((day) => {
            const hasBookings = day.bookings.length > 0;
            const isSelected = calendar.selectedIso === day.iso;
            const disabled = Boolean(day.isUnavailable);
            const classes = [
              'group flex h-28 flex-col justify-between rounded-lg border p-3 text-left text-sm shadow-sm transition hover:border-indigo-300 hover:shadow',
              statusClassForDay(day),
              day.isCurrentMonth === false ? 'opacity-60' : '',
              isSelected ? 'ring-2 ring-indigo-500 border-indigo-500' : '',
              disabled ? 'cursor-not-allowed opacity-60' : '',
            ].filter(Boolean).join(' ');
            const bookingsList = hasBookings
              ? `<ul class="space-y-1">${day.bookings.slice(0, 3).map((booking) => {
                  const statusClass = ({ approved:'bg-emerald-100 text-emerald-700', confirmed:'bg-emerald-100 text-emerald-700', pending:'bg-amber-100 text-amber-700', declined:'bg-rose-100 text-rose-700', rejected:'bg-rose-100 text-rose-700' }[booking.status]) ?? 'bg-indigo-100 text-indigo-700';
                  return `<li class="flex items-center rounded-md px-2 py-1 text-xs font-semibold ${statusClass}"><span class="truncate">${booking.customerName}</span></li>`;
                }).join('')}</ul>${day.bookings.length > 3 ? `<p class="text-[11px] text-slate-500">+${day.bookings.length - 3} more</p>` : ''}`
              : '';
            let statusMessage = '';
            if (day.isUnavailable) statusMessage = '<p class="rounded-md bg-slate-100 px-2 py-1 text-[11px] font-semibold text-slate-600">Unavailable</p>';
            else if (!hasBookings) statusMessage = '<p class="rounded-md bg-slate-100 px-2 py-1 text-[11px] font-semibold text-slate-600">Free</p>';
            else if (day.isFull) statusMessage = '<p class="rounded-md bg-rose-100 px-2 py-1 text-[11px] font-semibold text-rose-700">Fully booked</p>';

            return `<button type="button" class="${classes}" data-date="${day.iso}" ${disabled ? 'disabled' : ''} ${isSelected ? 'aria-current="date"' : ''}>
              <div class="flex items-start justify-between gap-2">
                <span class="text-base font-semibold">${day.dayLabel ?? day.dayNumber ?? day.iso.split('-').at(-1)}</span>
                ${day.isToday ? '<span class="rounded-full bg-indigo-50 px-2 py-0.5 text-[11px] font-medium text-indigo-600">Today</span>' : ''}
              </div>
              <div class="space-y-1 text-xs">
                ${bookingsList}
                ${statusMessage}
              </div>
            </button>`;
          }).join('');
          return `<div class="grid grid-cols-7 gap-1">${days}</div>`;
        }).join('');
        container.innerHTML = `${header}${weeks}`;
        container.querySelectorAll('button[data-date]').forEach((button) => {
          button.addEventListener('click', (e) => {
            const date = e.currentTarget.getAttribute('data-date');
            if (date) selectDay(date);
          });
        });
      }

      function renderDayOverview(day) { prefillRequestForm(day?.iso ?? null); }
      function renderPendingRequests() {}

      async function selectDay(dateIso) {
        try {
          const detail = await api(`/calendar/day?date=${encodeURIComponent(dateIso)}`);
          state.dayCache.set(dateIso, detail);
        } catch (error) {
          if (!state.dayCache.has(dateIso)) {
            console.warn('Falling back to cached day detail for', dateIso, error);
            const fallbackDetail = fallbackDayDetails[dateIso];
            if (fallbackDetail) state.dayCache.set(dateIso, clone(fallbackDetail)); else return;
          }
        }
        if (state.response?.calendar) state.response.calendar.selectedIso = dateIso;
        state.selectedDay = clone(state.dayCache.get(dateIso));
        renderDayOverview(state.selectedDay);
        renderCalendarGrid(state.response.calendar);
      }

      async function loadCalendar(options = {}) {
        const { month, selectedDate, resourceId } = options;
        const searchParams = new URLSearchParams();
        const requestedMonth = month || null;
        if (requestedMonth) searchParams.set('month', requestedMonth);
        if (selectedDate) searchParams.set('selectedDate', selectedDate);
        const targetResource = resourceId || state.response?.resource?.id;
        if (targetResource) searchParams.set('resourceId', targetResource);
        const query = searchParams.toString();
        const path = query ? `/calendar?${query}` : '/calendar';
        try {
          const data = await api(path);
          state.response = data;
          state.selectedDay = data.selectedDay ?? null;
          state.currentMonth = monthFromCalendar(data.calendar) ?? requestedMonth ?? resolveCurrentMonth();
          state.dayCache = new Map();
          if (state.selectedDay?.iso) state.dayCache.set(state.selectedDay.iso, clone(state.selectedDay));
        } catch (error) {
          console.warn('Using fallback calendar data because the API request failed.', error);
          const inferredSelectedMonth = selectedDate ? selectedDate.slice(0, 7) : null;
          const fallbackAnchor = parseMonthSlug(requestedMonth) ?? parseMonthSlug(inferredSelectedMonth) ?? new Date();
          const anchorUTC = new Date(Date.UTC(fallbackAnchor.getUTCFullYear(), fallbackAnchor.getUTCMonth(), 1));
          const { response: fallbackResp, dayDetails } = buildFallbackResponse(anchorUTC, new Date(), selectedDate ?? null);
          state.response = fallbackResp;
          state.selectedDay = clone(fallbackResp.selectedDay);
          state.dayCache = new Map(Object.entries(dayDetails).map(([k, d]) => [k, clone(d)]));
          state.currentMonth = monthFromCalendar(state.response.calendar) ?? formatMonthFromDate(anchorUTC);
        }
        renderSummary(state.response);
        renderCalendarGrid(state.response.calendar);
        renderDayOverview(state.selectedDay);
        renderPendingRequests();
      }

      function shiftMonth(offset) {
        const [year, monthNum] = resolveCurrentMonth().split('-').map(Number);
        if (!Number.isFinite(year) || !Number.isFinite(monthNum)) return;
        const shifted = new Date(Date.UTC(year, monthNum - 1 + offset, 1));
        const monthSlug = formatMonthFromDate(shifted);
        loadCalendar({ month: monthSlug });
      }

      function goToToday() {
        const today = new Date();
        loadCalendar({ month: formatMonthFromDate(today), selectedDate: formatIsoDate(today) });
      }

      if (newRequestForm) {
        if (startDateDisplay instanceof HTMLInputElement && endDateDisplay instanceof HTMLInputElement) {
          const normalizeDisplayInput = (displayInput, pickerInput) => {
            if (!(displayInput instanceof HTMLInputElement)) return null;
            if (displayInput.value.trim() === '') { if (pickerInput instanceof HTMLInputElement) pickerInput.value = ''; return null; }
            const iso = parseDisplayDate(displayInput.value);
            if (iso) {
              displayInput.value = formatDisplayDateFromIso(iso);
              if (pickerInput instanceof HTMLInputElement) pickerInput.value = iso;
            }
            return iso;
          };

          const resolveStartIso = () => {
            const displayIso = parseDisplayDate(startDateDisplay.value);
            if (displayIso) return displayIso;
            if (startDatePicker instanceof HTMLInputElement) {
              const pickerIso = parseDisplayDate(startDatePicker.value);
              if (pickerIso) return pickerIso;
            }
            return null;
          };

          const resolveEndIso = () => {
            const displayIso = parseDisplayDate(endDateDisplay.value);
            if (displayIso) return displayIso;
            if (endDatePicker instanceof HTMLInputElement) {
              const pickerIso = parseDisplayDate(endDatePicker.value);
              if (pickerIso) return pickerIso;
            }
            return null;
          };

          const syncEndDate = () => {
            const startIso = resolveStartIso();
            if (!startIso) { if (endDatePicker instanceof HTMLInputElement) endDatePicker.min = ''; return; }
            let endIso = resolveEndIso();
            if (!endIso || endIso < startIso) endIso = startIso;
            endDateDisplay.value = formatDisplayDateFromIso(endIso);
            if (endDatePicker instanceof HTMLInputElement) { endDatePicker.value = endIso; endDatePicker.min = startIso; }
          };

          const handleStartChange = () => {
            const iso = normalizeDisplayInput(startDateDisplay, startDatePicker);
            if (iso && endDatePicker instanceof HTMLInputElement) endDatePicker.min = iso;
            syncEndDate();
          };

          const handleEndChange = () => {
            normalizeDisplayInput(endDateDisplay, endDatePicker);
            syncEndDate();
          };

          ['change', 'blur'].forEach((eventName) => {
            startDateDisplay.addEventListener(eventName, handleStartChange);
            endDateDisplay.addEventListener(eventName, handleEndChange);
          });

          // Native pickers: rely on user click; only mirror on change
          if (startDatePicker instanceof HTMLInputElement) {
            startDatePicker.addEventListener('change', () => {
              const iso = parseDisplayDate(startDatePicker.value);
              if (!iso) return;
              startDateDisplay.value = formatDisplayDateFromIso(iso);
              if (endDatePicker instanceof HTMLInputElement) endDatePicker.min = iso;
              syncEndDate();
            });
          }
          if (endDatePicker instanceof HTMLInputElement) {
            endDatePicker.addEventListener('change', () => {
              const iso = parseDisplayDate(endDatePicker.value);
              if (!iso) return;
              endDateDisplay.value = formatDisplayDateFromIso(iso);
              syncEndDate();
            });
          }
        }

        newRequestForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          hideNewRequestStatus();
          const formData = new FormData(newRequestForm);
          const fullName = formData.get('fullName')?.toString().trim() ?? '';
          const startDateInputValue = formData.get('startDate')?.toString().trim() ?? '';
          const endDateInputValue = formData.get('endDate')?.toString().trim() ?? '';
          const notesValue = formData.get('notes');
          const resourceId = formData.get('resourceId')?.toString() || currentResourceId();
          const notes = notesValue ? notesValue.toString().trim() : '';

          if (!fullName || !startDateInputValue || !endDateInputValue) {
            showNewRequestStatus('Please complete all required fields.', 'error');
            return;
          }

          const startDateIso = parseDisplayDate(startDateInputValue);
          const endDateIso = parseDisplayDate(endDateInputValue);
          if (!startDateIso || !endDateIso) {
            showNewRequestStatus('Use dd.mm.yyyy or pick a date.', 'error');
            return;
          }
          if (endDateIso < startDateIso) {
            showNewRequestStatus('End date must be on or after the start date.', 'error');
            return;
          }

          const email = buildPlaceholderEmail(fullName);

          setNewRequestSubmitting(true);
          try {
            await api('/bookings', {
              method: 'POST',
              body: JSON.stringify({
                customer: { fullName, email },
                startDate: startDateIso,
                endDate: endDateIso,
                requestedBy: fullName,
                notes: notes || null,
                resourceId,
              }),
            });
            showNewRequestStatus('Request added to the calendar.', 'success');
            await loadCalendar({ month: startDateIso.slice(0, 7), selectedDate: startDateIso, resourceId });
            newRequestForm.reset();
            prefillRequestForm(startDateIso);
            window.setTimeout(() => { hideNewRequestStatus(); }, 2000);
          } catch (error) {
            console.error('Failed to create booking request', error);
            const message = error instanceof Error ? error.message : 'Failed to create booking request.';
            showNewRequestStatus(message, 'error');
          } finally {
            setNewRequestSubmitting(false);
          }
        });
      }

      document.querySelectorAll('[data-calendar-action]').forEach((button) => {
        button.addEventListener('click', (event) => {
          const action = event.currentTarget.getAttribute('data-calendar-action');
          if (action === 'prev') shiftMonth(-1);
          else if (action === 'next') shiftMonth(1);
          else if (action === 'today') goToToday();
        });
      });

      document.addEventListener('DOMContentLoaded', () => {
        prefillRequestForm(formatIsoDate(new Date()));
        // ensure min is set immediately
        const startIso = (function () {
          const v = startDatePicker?.value || '';
          return parseDisplayDate(v) || parseDisplayDate(startDateDisplay?.value || '');
        })();
        if (startIso && endDatePicker instanceof HTMLInputElement) endDatePicker.min = startIso;
        loadCalendar();
      });
      </script>
    </main>
  </body>
</html>
